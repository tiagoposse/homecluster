---
 #Â 
namespace: drone
releases:
  - chart: drone
    url: https://charts.tiagoposse.com/charts
    name: drone
    valuesFile: helm/drone-values.yml
    version: 0.1.7

  - chart: drone-runner-kube
    url: https://charts.tiagoposse.com/charts
    name: drone-runner
    namespace: builds
    valuesFile: helm/runner-values.yml
    version: 0.1.4
  
  - chart: drone-monorepo
    url: https://charts.tiagoposse.com/charts
    name: drone-monorepo
    valuesFile: helm/mono-values.yml
    version: 0.4.8
hooks:
  preInstall:
    - operation: apply
      resource: k8s/pvc.yml
    - operation: apply
      resource: k8s/build-sa.yml
    - operation: vault
  postInstall:
    - operation: apply
      resource: k8s/helm_auth.yml

vault:
  roles:
    - name: drone
      namespaces: drone
      sa: default
      policies: drone-pol
    - name: drone-runner
      namespaces: builds
      sa: drone-runner
      policies: drone-runner
    - name: drone-build
      namespaces: builds
      sa: drone-build-sa
      policies: drone-build
    - name: drone-monorepo
      namespaces: drone
      sa: drone-monorepo
      policies: drone-monorepo

  policies:
    - drone-pol
    - drone-runner
    - drone-build
    - drone-monorepo

  secrets:
    - path: kv/drone/github
      values:
        client_id: env_github_client_id
        client_secret: env_github_secret
    - path: kv/drone/rpc
      values:
        secret: gen
    - path: kv/drone/monorepo
      values:
        token: env_github_token